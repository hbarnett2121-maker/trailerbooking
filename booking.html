<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport"
        content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Trailer Booking</title>
  <meta name="color-scheme" content="light">
  <style>
    :root{
      --green:#06F713; --ink:#111; --muted:#6b7280; --border:#e5e7eb; --bg:#ffffff;
      --radius:16px;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:#f8fafc;color:var(--ink);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif}
    /* MOBILE-FIRST LAYOUT */
    .wrap{max-width:980px;margin:0 auto;padding:clamp(12px,3vw,20px); padding-bottom:96px;}
    h1{margin:8px 0 12px;font-size:clamp(22px,5vw,28px)}
    .card{background:#fff;border:1px solid var(--border);border-radius:var(--radius);
      box-shadow:0 6px 24px rgba(0,0,0,.06);padding:12px;margin:10px 0}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    .pill{min-height:44px;border:1px solid var(--border);border-radius:999px;padding:10px 14px;
      background:#fff;cursor:pointer;font-size:16px;line-height:1}
    .pill.active{border-color:var(--green);background:rgba(6,247,19,.12)}
    .toolbar{display:flex;align-items:center;justify-content:space-between;gap:8px}
    .btn{min-height:48px;border:1px solid var(--border);padding:12px 14px;border-radius:12px;
      background:#fff;cursor:pointer;font-size:16px}
    .btn.primary{background:var(--green);font-weight:700}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .calendar{display:grid;grid-template-columns:repeat(7,1fr);gap:6px}
    .dow{font-size:12px;color:var(--muted);text-align:center;padding:6px 0}
    .cell{border:1px solid var(--border);border-radius:10px;padding:10px;text-align:center;
      background:#fff;cursor:pointer;font-size:16px;min-height:44px}
    .cell.sel{border-width:2px;border-color:var(--green);background:rgba(6,247,19,.12)}
    .cell.dis{color:#9CA3AF;text-decoration:line-through;pointer-events:none}
    .grid{display:grid;gap:10px}
    /* TIME BUTTONS: 3 columns on phones, 6 on larger */
    .times{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
    @media (min-width:720px){ .times{grid-template-columns:repeat(6,1fr)} }
    .time{min-height:44px;border:1px solid var(--border);border-radius:10px;padding:10px;text-align:center;
      background:#fff;cursor:pointer;font-size:15px}
    .time.sel{border-width:2px;border-color:var(--green);background:rgba(6,247,19,.12)}
    .time.dis{color:#9CA3AF;text-decoration:line-through;cursor:not-allowed}
    .hint{font-size:13px;color:var(--muted)}
    .kvs{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0}
    .kv{border:1px solid var(--green);border-radius:999px;padding:6px 10px;font-size:13px}
    /* STICKY FOOTER ACTION BAR ON MOBILE */
    .bar{position:fixed;left:0;right:0;bottom:env(safe-area-inset-bottom);
      background:#fff;border-top:1px solid var(--border);padding:10px 14px;display:flex;gap:10px;align-items:center;justify-content:space-between}
    .bar .summary{font-size:13px;color:var(--muted);line-height:1.2;max-width:65%}
    .bar .primary{min-width:44%;}

    /* MODAL */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;padding:16px}
    .modal.open{display:flex}
    .sheet{background:#fff;border-radius:16px;max-width:640px;width:100%;padding:14px;border:1px solid var(--border)}
    .field{display:flex;flex-direction:column;gap:6px}
    input,textarea,select{border:1px solid var(--border);border-radius:10px;padding:12px;font-size:16px;background:#fff}
    .toast{position:fixed;right:14px;bottom:64px;background:var(--green);padding:14px 16px;border-radius:12px;
      box-shadow:0 10px 20px rgba(0,0,0,.1);font-size:14px;max-width:320px;line-height:1.4}

    /* SMALL SCREEN TWEAKS */
    @media (max-width:420px){
      .calendar{gap:4px}
      .cell{padding:8px;font-size:15px}
      .btn{padding:10px 12px}
    }
  </style>
</head>
<body>
  <div class="wrap" id="wrap">
    <h1>Trailer Booking</h1>

    <!-- TRAILER PICKER -->
    <div class="card">
      <div class="row" id="trailers"></div>
    </div>

    <!-- MONTH CALENDAR -->
    <div class="card">
      <div class="toolbar" style="margin-bottom:8px">
        <button class="btn" id="prev">←</button>
        <div id="monthLabel" class="hint" style="font-size:16px;color:var(--ink);font-weight:700"></div>
        <button class="btn" id="next">→</button>
      </div>
      <div class="calendar" id="dow"></div>
      <div class="calendar" id="cal"></div>
      <div class="hint" id="dateHint"></div>
    </div>

    <!-- TIMES -->
    <div class="card">
      <div class="grid">
        <div>
          <div class="hint" style="margin-bottom:6px">Pickup (6 AM – 6 PM)</div>
          <div class="times" id="pickup"></div>
        </div>
        <div>
          <div class="hint" style="margin-bottom:6px">Dropoff (6 AM – 6 PM)</div>
          <div class="times" id="dropoff"></div>
        </div>
        <div class="hint">Conflicting times are crossed out.</div>
      </div>
    </div>
  </div>

  <!-- STICKY ACTION BAR -->
  <div class="bar">
    <div class="summary" id="summary">Pick trailer, dates & times to book.</div>
    <button class="btn primary" id="bookBtn" disabled>Book</button>
  </div>

  <!-- BOOKING MODAL -->
  <div class="modal" id="modal">
    <div class="sheet">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <div style="font-weight:700">Complete Your Booking</div>
        <button class="btn" id="closeModal">✕</button>
      </div>
      <div class="kvs" id="kv"></div>
      <div class="grid" style="grid-template-columns:1fr;gap:12px">
        <div class="field"><label>First name</label><input id="fn" placeholder="Jane"></div>
        <div class="field"><label>Last name</label><input id="ln" placeholder="Doe"></div>
        <div class="field"><label>Email</label><input id="email" type="email" placeholder="jane@example.com"></div>
        <div class="field"><label>Phone number</label><input id="phone" type="tel" placeholder="(555) 123-4567"></div>
        <div class="field"><label>Date of birth</label><input id="dob" type="date"></div>
        <div class="field">
          <label>Upload driver's license</label>
          <input id="license" type="file" accept="image/*" style="padding:8px;border:1px solid #ddd;border-radius:4px;width:100%">
          <div style="font-size:12px;color:#666;margin-top:4px">Please upload a clear photo of your driver's license (JPEG or PNG)</div>
        </div>
        <div class="field"><label>Reason for booking the trailer</label><textarea id="reason" rows="4" placeholder="Hauling appliances, moving, landscaping project, etc."></textarea></div>
      </div>
      <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px">
        <button class="btn" id="cancel">Cancel</button>
        <button class="btn primary" id="submit">Submit</button>
      </div>
    </div>
  </div>

  <script>
    // ===== SET THIS TO YOUR LIVE HTTPS ENDPOINT =====
    const BOOKING_API_ENDPOINT = "https://trailerbookingrrwal.vercel.app/api/book";

    // Data / utils
    const TRAILERS = ["10 Ft Utility Trailer","12 Ft Cargo Trailer","20 Ft Car Hauler","20 Ft Utility Trailer","16 Ft Pipe Utility Trailer","16 Ft Ramp Utility Trailer"];
    const HOURS = Array.from({length:13}, (_,i)=>6+i); // 6..18
    const STORAGE_KEY = "trailer_reservations_v1";
    const $ = (id)=>document.getElementById(id);
    const fmtDate = (d)=>`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
    const timeLabel=(h)=>{const s=h>=12?"PM":"AM";const v=h%12===0?12:h%12;return `${v}:00 ${s}`};
    const sameDay=(a,b)=>a.getFullYear()===b.getFullYear()&&a.getMonth()===b.getMonth()&&a.getDate()===b.getDate();
    const stripTime=(d)=>new Date(d.getFullYear(), d.getMonth(), d.getDate());
    function saveReservations(r){ localStorage.setItem(STORAGE_KEY, JSON.stringify(r)); }
    function loadReservations(){ try{ return JSON.parse(localStorage.getItem(STORAGE_KEY)||"[]"); }catch{ return []; } }
    function overlaps(a,b){
      const dateOverlap = !(new Date(a.endDate) < new Date(b.startDate) || new Date(b.endDate) < new Date(a.startDate));
      if(!dateOverlap) return false;
      return !(a.dropoffHour < b.pickupHour || b.dropoffHour < a.pickupHour);
    }

    // State
    let state = {
      trailer: TRAILERS[0],
      visible: new Date(new Date().getFullYear(), new Date().getMonth(), 1),
      start: null, end: null, pickup: null, dropoff: null,
      reservations: loadReservations()
    };

    // UI
    function renderTrailers(){
      const c = $("trailers"); c.innerHTML = "";
      TRAILERS.forEach(t=>{
        const btn = document.createElement('button');
        btn.className = 'pill'+(state.trailer===t?' active':'');
        btn.textContent = t;
        btn.onclick = ()=>{ state.trailer=t; state.pickup=null; state.dropoff=null; draw(); };
        c.appendChild(btn);
      });
    }

    function renderMonth(){
      $("monthLabel").textContent = state.visible.toLocaleString(undefined,{month:'long',year:'numeric'});
      const dow = $("dow"); dow.innerHTML=""; ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"].forEach(d=>{
        const el = document.createElement('div'); el.className='dow'; el.textContent=d; dow.appendChild(el);
      });

      const cal = $("cal"); cal.innerHTML="";
      const y = state.visible.getFullYear(), m = state.visible.getMonth();
      const first = new Date(y,m,1), startWeek = first.getDay();
      const daysInMonth = new Date(y,m+1,0).getDate();

      // fully booked
      const full = new Set();
      const forTrailer = state.reservations.filter(r=>r.trailer===state.trailer);
      forTrailer.forEach(r=>{
        const sd=new Date(r.startDate), ed=new Date(r.endDate);
        for(let d=new Date(sd); d<=ed; d.setDate(d.getDate()+1)){
          if(r.pickupHour<=6 && r.dropoffHour>=18) full.add(fmtDate(d));
        }
      });

      for(let i=0;i<startWeek;i++){ cal.appendChild(document.createElement('div')); }
      for(let d=1; d<=daysInMonth; d++){
        const date = new Date(y,m,d), ds = fmtDate(date);
        const el = document.createElement('button'); el.className='cell'; el.textContent = d;
        const selected = (state.start && sameDay(date,state.start)) || (state.end && sameDay(date,state.end)) ||
                         (state.start && state.end && date>=stripTime(state.start) && date<=stripTime(state.end));
        if(selected) el.classList.add('sel');
        if(full.has(ds)) el.classList.add('dis');
        el.onclick = ()=>pickDate(date);
        cal.appendChild(el);
      }

      const hint = $("dateHint");
      if(state.start && !state.end) hint.textContent = `Start date: ${fmtDate(state.start)} — select end date.`;
      else if(state.start && state.end) hint.textContent = `Selected: ${fmtDate(state.start)} to ${fmtDate(state.end)}`;
      else hint.textContent='';
    }

    function pickDate(date){
      if(!state.start || (state.start && state.end)){
        state.start = date; state.end=null; state.pickup=null; state.dropoff=null;
      } else if(date < state.start){
        state.end = state.start; state.start = date; state.pickup=null; state.dropoff=null;
      } else {
        state.end = date; state.pickup=null; state.dropoff=null;
      }
      draw();
    }

    function disabledHours(){
      if(!state.start || !state.end) return {pickup:[], dropoff:[]};
      const rFor = state.reservations.filter(r=>r.trailer===state.trailer);
      const dis = new Set();
      const range = { startDate: fmtDate(state.start), endDate: fmtDate(state.end), pickupHour:6, dropoffHour:18 };
      rFor.forEach(r=>{ if(overlaps(range,r)){ for(let h=r.pickupHour; h<=r.dropoffHour; h++) dis.add(h); } });
      const arr = [...dis].sort((a,b)=>a-b);
      return { pickup: arr, dropoff: arr };
    }

    function renderTimes(){
      const dis = disabledHours();
      const p = $("pickup"), d=$("dropoff"); p.innerHTML=""; d.innerHTML="";
      HOURS.forEach(h=>{
        const bp = document.createElement('button');
        bp.className='time'+(state.pickup===h?' sel':'')+(dis.pickup.includes(h)?' dis':'');
        bp.textContent=timeLabel(h); bp.disabled=dis.pickup.includes(h);
        bp.onclick=()=>{ state.pickup=h; draw(); };
        p.appendChild(bp);

        const bd = document.createElement('button');
        bd.className='time'+(state.dropoff===h?' sel':'')+(dis.dropoff.includes(h)?' dis':'');
        bd.textContent=timeLabel(h); bd.disabled=dis.dropoff.includes(h);
        bd.onclick=()=>{ state.dropoff=h; draw(); };
        d.appendChild(bd);
      });
    }

    function renderSummary(){
      const ready = state.trailer && state.start && state.end &&
                    state.pickup!==null && state.dropoff!==null && state.dropoff>=state.pickup;
      $("bookBtn").disabled = !ready;
      $("summary").textContent = ready
        ? `${state.trailer} — ${fmtDate(state.start)} → ${fmtDate(state.end)}, ${timeLabel(state.pickup)} → ${timeLabel(state.dropoff)}`
        : 'Pick trailer, dates & times to book.';
    }

    function draw(){ renderTrailers(); renderMonth(); renderTimes(); renderSummary(); }

    // Nav
    $("prev").onclick = ()=>{ state.visible = new Date(state.visible.getFullYear(), state.visible.getMonth()-1, 1); draw(); };
    $("next").onclick = ()=>{ state.visible = new Date(state.visible.getFullYear(), state.visible.getMonth()+1, 1); draw(); };

    // Modal controls
    $("bookBtn").onclick = ()=>{
      $("kv").innerHTML = '';
      const add=(t)=>{ const b=document.createElement('div'); b.className='kv'; b.textContent=t; $("kv").appendChild(b); };
      add(state.trailer);
      add(`${fmtDate(state.start)} → ${fmtDate(state.end)}`);
      add(`${timeLabel(state.pickup)} → ${timeLabel(state.dropoff)}`);
      $("modal").classList.add('open');
    };
    ["closeModal","cancel"].forEach(id=>$(id).onclick=()=>$("modal").classList.remove('open'));

    // Compress and resize image to reduce file size
    async function compressImage(file, maxWidth = 1200, quality = 0.8) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (e) => {
          const img = new Image();
          img.onload = () => {
            const canvas = document.createElement('canvas');
            let width = img.width;
            let height = img.height;

            // Resize if image is too large
            if (width > maxWidth) {
              height = (height * maxWidth) / width;
              width = maxWidth;
            }

            canvas.width = width;
            canvas.height = height;

            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, width, height);

            // Convert to base64 with compression
            const base64 = canvas.toDataURL('image/jpeg', quality).split(',')[1];
            resolve(base64);
          };
          img.onerror = reject;
          img.src = e.target.result;
        };
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    $("submit").onclick = async ()=>{
      // Get file and compress/convert to base64 if present
      const licenseFile = $("license").files[0];
      let licenseData = null;
      let licenseFilename = null;

      if (licenseFile) {
        try {
          // Compress and resize image
          licenseData = await compressImage(licenseFile);
          licenseFilename = licenseFile.name.replace(/\.[^/.]+$/, '.jpg'); // Change extension to .jpg
        } catch (error) {
          alert('Failed to process image. Please try a different photo.');
          return;
        }
      }

      const record = {
        trailer: state.trailer,
        startDate: fmtDate(state.start),
        endDate: fmtDate(state.end),
        pickupHour: state.pickup,
        dropoffHour: state.dropoff,
        firstName: $("fn").value.trim(),
        lastName: $("ln").value.trim(),
        email: $("email").value.trim(),
        phone: $("phone").value.trim(),
        dob: $("dob").value,
        driversLicense: licenseData,
        driversLicenseFilename: licenseFilename,
        reason: $("reason").value.trim(),
        createdAt: new Date().toISOString(),
      };
      const missing = [];
      if(!record.firstName) missing.push('First name');
      if(!record.lastName) missing.push('Last name');
      if(!record.email) missing.push('Email');
      if(!record.phone) missing.push('Phone number');
      if(!record.dob) missing.push('Date of birth');
      if(!record.driversLicense) missing.push('Driver\'s license photo');
      if(!record.reason) missing.push('Reason');
      if(missing.length){ alert('Please fill: '+missing.join(', ')); return; }

      // inside your "Submit" button onclick handler:
      try {
        const resp = await fetch(BOOKING_API_ENDPOINT, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(record)
        });


        if (!resp.ok) throw new Error("HTTP " + resp.status);

        // mark times as taken and show success
        const list = loadReservations(); list.push(record); saveReservations(list);
        $("modal").classList.remove("open");
        const t = document.createElement("div"); t.className = "toast"; t.textContent = "Thank you for your booking! We've received your request and will be in touch shortly with the next steps via email.";
        document.body.appendChild(t); setTimeout(()=>t.remove(),5000);
        state.start=null; state.end=null; state.pickup=null; state.dropoff=null; state.reservations=list; draw();
      } catch (e) {
        alert("Could not submit booking. " + (e?.message || ""));
      }
    };

    // Init
    draw();
  </script>
</body>
</html>

