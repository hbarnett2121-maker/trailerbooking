<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport"
        content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Trailer Booking</title>
  <meta name="color-scheme" content="light">
  <style>
    :root{
      --green:#06F713; --ink:#111; --muted:#6b7280; --border:#e5e7eb; --bg:#ffffff;
      --radius:16px;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:#f8fafc;color:var(--ink);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif}
    /* MOBILE-FIRST LAYOUT */
    .wrap{max-width:980px;margin:0 auto;padding:clamp(12px,3vw,20px); padding-bottom:96px;}
    h1{margin:8px 0 12px;font-size:clamp(22px,5vw,28px)}
    .card{background:#fff;border:1px solid var(--border);border-radius:var(--radius);
      box-shadow:0 6px 24px rgba(0,0,0,.06);padding:12px;margin:10px 0}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    .pill{min-height:44px;border:1px solid var(--border);border-radius:999px;padding:10px 14px;
      background:#fff;cursor:pointer;font-size:16px;line-height:1}
    .pill.active{border-color:var(--green);background:rgba(6,247,19,.12)}
    .toolbar{display:flex;align-items:center;justify-content:space-between;gap:8px}
    .btn{min-height:48px;border:1px solid var(--border);padding:12px 14px;border-radius:12px;
      background:#fff;cursor:pointer;font-size:16px}
    .btn.primary{background:var(--green);font-weight:700}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .calendar{display:grid;grid-template-columns:repeat(7,1fr);gap:6px}
    .dow{font-size:12px;color:var(--muted);text-align:center;padding:6px 0;font-weight:600}
    .cell{border:1px solid var(--border);border-radius:10px;padding:10px;text-align:center;
      background:#fff;cursor:pointer;font-size:16px;min-height:44px;position:relative;transition:all 0.2s ease}
    .cell:not(.dis):hover{border-color:var(--green);background:rgba(6,247,19,.05);transform:scale(1.05)}
    .cell.sel{border-width:2px;border-color:var(--green);background:rgba(6,247,19,.12);font-weight:700}
    .cell.start{border-width:3px;border-color:#00D100;background:linear-gradient(135deg, rgba(6,247,19,.25), rgba(6,247,19,.15));box-shadow:0 2px 8px rgba(6,247,19,.3)}
    .cell.end{border-width:3px;border-color:#00D100;background:linear-gradient(135deg, rgba(6,247,19,.25), rgba(6,247,19,.15));box-shadow:0 2px 8px rgba(6,247,19,.3)}
    .cell.range{background:rgba(6,247,19,.08);border-color:rgba(6,247,19,.3)}
    .cell.dis{color:#9CA3AF;text-decoration:line-through;pointer-events:none;opacity:0.5}
    .pin{position:absolute;top:-8px;left:50%;transform:translateX(-50%);background:var(--green);color:#000;
      font-size:9px;font-weight:800;padding:2px 6px;border-radius:4px;white-space:nowrap;box-shadow:0 2px 4px rgba(0,0,0,.2)}
    .instruction-box{background:linear-gradient(135deg, #f0fdf4, #dcfce7);border:2px solid var(--green);
      border-radius:12px;padding:12px 16px;margin:12px 0;font-size:14px;line-height:1.6;font-weight:500}
    .instruction-box .step{color:#059669;font-weight:700}
    .instruction-box.warning{background:linear-gradient(135deg, #fef3c7, #fde68a);border-color:#f59e0b}
    .instruction-box.warning .step{color:#d97706}
    .date-range-display{background:#fff;border:2px solid var(--green);border-radius:12px;padding:10px 14px;
      margin:8px 0;font-size:14px;font-weight:600;color:var(--ink);text-align:center}
    .grid{display:grid;gap:10px}
    /* TIME BUTTONS: 3 columns on phones, 6 on larger */
    .times{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
    @media (min-width:720px){ .times{grid-template-columns:repeat(6,1fr)} }
    .time{min-height:44px;border:1px solid var(--border);border-radius:10px;padding:10px;text-align:center;
      background:#fff;cursor:pointer;font-size:15px}
    .time.sel{border-width:2px;border-color:var(--green);background:rgba(6,247,19,.12)}
    .time.dis{color:#9CA3AF;text-decoration:line-through;cursor:not-allowed}
    .hint{font-size:13px;color:var(--muted)}
    .kvs{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0}
    .kv{border:1px solid var(--green);border-radius:999px;padding:6px 10px;font-size:13px}
    /* STICKY FOOTER ACTION BAR ON MOBILE */
    .bar{position:fixed;left:0;right:0;bottom:env(safe-area-inset-bottom);
      background:#fff;border-top:1px solid var(--border);padding:10px 14px;display:flex;gap:10px;align-items:center;justify-content:space-between}
    .bar .summary{font-size:13px;color:var(--muted);line-height:1.2;max-width:65%}
    .bar .primary{min-width:44%;}

    /* MODAL */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;padding:16px;z-index:1000}
    .modal.open{display:flex}
    .sheet{background:#fff;border-radius:16px;max-width:640px;width:100%;max-height:90vh;display:flex;flex-direction:column;border:1px solid var(--border)}
    .sheet-header{padding:14px;border-bottom:1px solid var(--border)}
    .sheet-content{padding:14px;overflow-y:auto;flex:1}
    .sheet-footer{padding:14px;border-top:1px solid var(--border);display:flex;justify-content:flex-end;gap:8px}
    .field{display:flex;flex-direction:column;gap:6px}
    input,textarea,select{border:1px solid var(--border);border-radius:10px;padding:12px;font-size:16px;background:#fff}
    .toast{position:fixed;right:14px;bottom:64px;background:var(--green);padding:14px 16px;border-radius:12px;
      box-shadow:0 10px 20px rgba(0,0,0,.1);font-size:14px;max-width:320px;line-height:1.4}
    .loading-overlay{position:fixed;inset:0;background:rgba(0,0,0,.8);display:none;align-items:center;justify-content:center;z-index:2000;flex-direction:column;color:white}
    .loading-overlay.show{display:flex}
    .spinner{width:60px;height:60px;border:6px solid rgba(255,255,255,.3);border-top-color:var(--green);border-radius:50%;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}

    /* SMALL SCREEN TWEAKS */
    @media (max-width:420px){
      .calendar{gap:4px}
      .cell{padding:8px;font-size:15px;min-height:48px}
      .btn{padding:10px 12px}
      .pin{font-size:8px;padding:2px 4px;top:-6px}
      .instruction-box{font-size:13px;padding:10px 12px}
      .date-range-display{font-size:13px;padding:8px 12px}
    }
  </style>
</head>
<body>
  <div class="wrap" id="wrap">
    <h1>Trailer Booking</h1>

    <!-- TRAILER PICKER -->
    <div class="card">
      <div style="font-weight:700;font-size:15px;margin-bottom:10px;color:var(--ink)">üöö Select Your Trailer</div>
      <div style="font-size:13px;color:var(--muted);margin-bottom:10px;font-weight:500">‚ö†Ô∏è All trailer rentals have a <strong style="color:#d97706">2-hour minimum</strong></div>
      <div class="row" id="trailers"></div>
    </div>

    <!-- MONTH CALENDAR -->
    <div class="card">
      <div style="font-weight:700;font-size:15px;margin-bottom:10px;color:var(--ink)">üìÖ Choose Your Rental Dates</div>
      <div class="toolbar" style="margin-bottom:8px">
        <button class="btn" id="prev">‚Üê</button>
        <div id="monthLabel" class="hint" style="font-size:16px;color:var(--ink);font-weight:700"></div>
        <button class="btn" id="next">‚Üí</button>
      </div>
      <div class="calendar" id="dow"></div>
      <div class="calendar" id="cal"></div>
      <div class="hint" id="dateHint"></div>
    </div>

    <!-- TIMES -->
    <div class="card">
      <div style="font-weight:700;font-size:15px;margin-bottom:10px;color:var(--ink)">‚è∞ Select Pickup & Dropoff Times</div>
      <div class="instruction-box" style="margin-top:0"><span class="step">STEP 2:</span> Select your pickup and dropoff times (6 AM ‚Äì 6 PM). <strong style="color:#d97706">‚ö†Ô∏è 2-HOUR MINIMUM REQUIRED.</strong> Times that conflict with existing bookings are crossed out.</div>
      <div id="timeWarning"></div>
      <div class="grid">
        <div>
          <div class="hint" style="margin-bottom:6px;font-weight:600;font-size:14px">üìç Pickup Time</div>
          <div class="times" id="pickup"></div>
        </div>
        <div>
          <div class="hint" style="margin-bottom:6px;font-weight:600;font-size:14px">üìç Dropoff Time</div>
          <div class="times" id="dropoff"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- STICKY ACTION BAR -->
  <div class="bar">
    <div class="summary" id="summary">Pick trailer, dates & times to book.</div>
    <button class="btn primary" id="bookBtn" disabled>Book</button>
  </div>

  <!-- BOOKING MODAL -->
  <div class="modal" id="modal">
    <div class="sheet">
      <div class="sheet-header">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="font-weight:700">Complete Your Booking</div>
          <button class="btn" id="closeModal" style="padding:4px 8px;min-height:32px">‚úï</button>
        </div>
      </div>
      <div class="sheet-content">
        <div class="kvs" id="kv" style="margin-bottom:12px"></div>
        <div class="grid" style="grid-template-columns:1fr;gap:12px">
          <div class="field"><label>First name</label><input id="fn" placeholder="Jane"></div>
          <div class="field"><label>Last name</label><input id="ln" placeholder="Doe"></div>
          <div class="field"><label>Email</label><input id="email" type="email" placeholder="jane@example.com"></div>
          <div class="field"><label>Phone number</label><input id="phone" type="tel" placeholder="(555) 123-4567"></div>
          <div class="field"><label>Date of birth</label><input id="dob" type="date"></div>
          <div class="field">
            <label>Upload driver's license</label>
            <input id="license" type="file" accept="image/*" style="padding:8px;border:1px solid #ddd;border-radius:4px;width:100%">
            <div style="font-size:12px;color:#666;margin-top:4px">Please upload a clear photo of your driver's license (JPEG or PNG)</div>
          </div>
          <div class="field">
            <label>Upload proof of insurance</label>
            <input id="insurance" type="file" accept="image/*" style="padding:8px;border:1px solid #ddd;border-radius:4px;width:100%">
            <div style="font-size:12px;color:#666;margin-top:4px">Please upload a clear photo of your insurance card or document (JPEG or PNG)</div>
          </div>
          <div class="field"><label>What are you hauling with this trailer?</label><textarea id="reason" rows="3" placeholder="Furniture, appliances, landscaping materials, etc."></textarea></div>
          <div class="field">
            <label>Have you hauled a trailer before?</label>
            <select id="trailerExperience" style="padding:12px;border:2px solid #e0e0e0;border-radius:8px;width:100%;font-size:16px">
              <option value="">Select an option...</option>
              <option value="yes">Yes, I've hauled a trailer before</option>
              <option value="no">No, I haven't. Can I get a walkthrough?</option>
            </select>
          </div>
        </div>
      </div>
      <div class="sheet-footer">
        <button class="btn" id="cancel">Cancel</button>
        <button class="btn primary" id="submit">Pay & Book</button>
      </div>
    </div>
  </div>

  <!-- LOADING OVERLAY FOR MOBILE REDIRECT -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="spinner"></div>
    <div style="margin-top:20px;font-size:18px;font-weight:600">Redirecting to payment...</div>
    <div style="margin-top:8px;font-size:14px;opacity:0.8">Please wait</div>
  </div>

  <script>
    // ===== SET THIS TO YOUR LIVE HTTPS ENDPOINT =====
    const CHECKOUT_API_ENDPOINT = "https://trailerbookingrrwal.vercel.app/api/create-checkout";

    // Data / utils
    // IMPORTANT: These trailer names must EXACTLY match the PRICING keys and backend API
    const TRAILERS = [
      "5 x 10 Utility Trailer",
      "6 x 12 Cargo Trailer",
      "7 x 16 Utility Pipe Trailer",
      "7 x 16 Utility Ramp Trailer",
      "7 x 20 Utility Trailer",
      "8.5 x 20 Car Hauler"
    ];
    const HOURS = Array.from({length:13}, (_,i)=>6+i); // 6..18
    const STORAGE_KEY = "trailer_reservations_v1";

    // ========================================
    // EXISTING BOOKINGS - MANAGED MANUALLY
    // ========================================
    // Add new confirmed bookings here after they complete payment.
    // Format: { trailer: "exact name", startDate: "YYYY-MM-DD", endDate: "YYYY-MM-DD", pickupHour: 6-18, dropoffHour: 6-18 }
    const CONFIRMED_BOOKINGS = [
      // Add confirmed bookings here after they complete payment:
      // {
      //   trailer: "8.5 x 20 Car Hauler",
      //   startDate: "2025-11-28",
      //   endDate: "2025-11-28",
      //   pickupHour: 12,
      //   dropoffHour: 15,
      //   note: "Customer name or reference"
      // },
    ];

    // Pricing structure - MUST match TRAILERS array and backend API exactly
    const PRICING = {
      "5 x 10 Utility Trailer": { hourly: 15, daily: 45, weekly: 250, monthly: 750 },
      "6 x 12 Cargo Trailer": { hourly: 20, daily: 55, weekly: 300, monthly: 1900 },
      "7 x 16 Utility Pipe Trailer": { hourly: 25, daily: 65, weekly: 350, monthly: 1100 },
      "7 x 16 Utility Ramp Trailer": { hourly: 25, daily: 65, weekly: 350, monthly: 1100 },
      "7 x 20 Utility Trailer": { hourly: 30, daily: 75, weekly: 300, monthly: 1300 },
      "8.5 x 20 Car Hauler": { hourly: 40, daily: 95, weekly: 600, monthly: 2000 }
    };

    function calculatePrice() {
      if (!state.trailer || !state.start || !state.end || state.pickup === null || state.dropoff === null) {
        return null;
      }

      const pricing = PRICING[state.trailer];
      if (!pricing) return null;

      // Calculate total rental hours (not calendar days)
      const startDateTime = new Date(state.start);
      startDateTime.setHours(state.pickup, 0, 0, 0);

      const endDateTime = new Date(state.end);
      endDateTime.setHours(state.dropoff, 0, 0, 0);

      const totalHours = (endDateTime - startDateTime) / (1000 * 60 * 60);

      let tier, price, breakdown;

      if (totalHours >= 720) { // 30 days = 720 hours -> monthly
        const months = Math.floor(totalHours / 720);
        const remainingHours = totalHours - (months * 720);
        const remainingWeeks = Math.floor(remainingHours / 168);
        const afterWeeks = remainingHours - (remainingWeeks * 168);
        const remainingDays = Math.floor(afterWeeks / 24);
        const finalHours = Math.ceil(afterWeeks - (remainingDays * 24));

        price = (months * pricing.monthly) + (remainingWeeks * pricing.weekly) +
                (remainingDays * pricing.daily) + (finalHours * pricing.hourly);

        const parts = [];
        if (months > 0) parts.push(`${months} month${months > 1 ? 's' : ''}`);
        if (remainingWeeks > 0) parts.push(`${remainingWeeks} week${remainingWeeks > 1 ? 's' : ''}`);
        if (remainingDays > 0) parts.push(`${remainingDays} day${remainingDays > 1 ? 's' : ''}`);
        if (finalHours > 0) parts.push(`${finalHours} hr${finalHours > 1 ? 's' : ''}`);

        tier = "Monthly Rate";
        breakdown = parts.join(' + ');
      } else if (totalHours >= 168) { // 7 days = 168 hours -> weekly
        const weeks = Math.floor(totalHours / 168);
        const remainingHours = totalHours - (weeks * 168);
        const remainingDays = Math.floor(remainingHours / 24);
        const finalHours = Math.ceil(remainingHours - (remainingDays * 24));

        price = (weeks * pricing.weekly) + (remainingDays * pricing.daily) + (finalHours * pricing.hourly);

        const parts = [];
        if (weeks > 0) parts.push(`${weeks} week${weeks > 1 ? 's' : ''}`);
        if (remainingDays > 0) parts.push(`${remainingDays} day${remainingDays > 1 ? 's' : ''}`);
        if (finalHours > 0) parts.push(`${finalHours} hr${finalHours > 1 ? 's' : ''}`);

        tier = "Weekly Rate";
        breakdown = parts.join(' + ');
      } else if (totalHours >= 24) { // 24+ hours = daily rate
        const days = Math.floor(totalHours / 24);
        const remainingHours = Math.ceil(totalHours - (days * 24));

        price = (days * pricing.daily) + (remainingHours * pricing.hourly);

        const parts = [];
        if (days > 0) parts.push(`${days} day${days > 1 ? 's' : ''}`);
        if (remainingHours > 0) parts.push(`${remainingHours} hr${remainingHours > 1 ? 's' : ''}`);

        tier = "Daily Rate";
        breakdown = parts.join(' + ');
      } else { // Less than 24 hours = hourly rate
        const hours = Math.max(Math.ceil(totalHours), 2); // 2 hour minimum
        tier = "Hourly Rate (2 hr min)";
        price = pricing.hourly * hours;
        breakdown = `${hours} hour${hours > 1 ? 's' : ''} √ó $${pricing.hourly}`;
      }

      return { tier, price, breakdown };
    }

    const $ = (id)=>document.getElementById(id);
    const fmtDate = (d)=>`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
    const timeLabel=(h)=>{const s=h>=12?"PM":"AM";const v=h%12===0?12:h%12;return `${v}:00 ${s}`};
    const sameDay=(a,b)=>a.getFullYear()===b.getFullYear()&&a.getMonth()===b.getMonth()&&a.getDate()===b.getDate();
    const stripTime=(d)=>new Date(d.getFullYear(), d.getMonth(), d.getDate());
    function saveReservations(r){ localStorage.setItem(STORAGE_KEY, JSON.stringify(r)); }
    function loadReservations(){ try{ return JSON.parse(localStorage.getItem(STORAGE_KEY)||"[]"); }catch{ return []; } }
    function overlaps(a,b){
      const dateOverlap = !(new Date(a.endDate) < new Date(b.startDate) || new Date(b.endDate) < new Date(a.startDate));
      if(!dateOverlap) return false;
      return !(a.dropoffHour < b.pickupHour || b.dropoffHour < a.pickupHour);
    }

    // State
    let state = {
      trailer: TRAILERS[0],
      visible: new Date(new Date().getFullYear(), new Date().getMonth(), 1),
      start: null, end: null, pickup: null, dropoff: null,
      reservations: [...CONFIRMED_BOOKINGS, ...loadReservations()]
    };

    // UI
    function renderTrailers(){
      const c = $("trailers"); c.innerHTML = "";
      TRAILERS.forEach(t=>{
        const btn = document.createElement('button');
        btn.className = 'pill'+(state.trailer===t?' active':'');
        btn.textContent = t;
        btn.onclick = ()=>{ state.trailer=t; state.pickup=null; state.dropoff=null; draw(); };
        c.appendChild(btn);
      });
    }

    function renderMonth(){
      $("monthLabel").textContent = state.visible.toLocaleString(undefined,{month:'long',year:'numeric'});
      const dow = $("dow"); dow.innerHTML=""; ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"].forEach(d=>{
        const el = document.createElement('div'); el.className='dow'; el.textContent=d; dow.appendChild(el);
      });

      const cal = $("cal"); cal.innerHTML="";
      const y = state.visible.getFullYear(), m = state.visible.getMonth();
      const first = new Date(y,m,1), startWeek = first.getDay();
      const daysInMonth = new Date(y,m+1,0).getDate();

      // fully booked
      const full = new Set();
      const forTrailer = state.reservations.filter(r=>r.trailer===state.trailer);
      forTrailer.forEach(r=>{
        const sd=new Date(r.startDate), ed=new Date(r.endDate);
        for(let d=new Date(sd); d<=ed; d.setDate(d.getDate()+1)){
          if(r.pickupHour<=6 && r.dropoffHour>=18) full.add(fmtDate(d));
        }
      });

      for(let i=0;i<startWeek;i++){ cal.appendChild(document.createElement('div')); }
      for(let d=1; d<=daysInMonth; d++){
        const date = new Date(y,m,d), ds = fmtDate(date);
        const el = document.createElement('button'); el.className='cell';

        // Check if this is start, end, or in range
        const isStart = state.start && sameDay(date,state.start);
        const isEnd = state.end && sameDay(date,state.end);
        const isInRange = state.start && state.end && !sameDay(state.start, state.end) &&
                          date > stripTime(state.start) && date < stripTime(state.end);

        // Set the day number
        el.textContent = d;

        // Add appropriate classes
        if(isStart) {
          el.classList.add('start', 'sel');
          const pin = document.createElement('div');
          pin.className = 'pin';
          pin.textContent = 'üìç START';
          el.appendChild(pin);
        }
        if(isEnd && !isStart) {
          el.classList.add('end', 'sel');
          const pin = document.createElement('div');
          pin.className = 'pin';
          pin.textContent = 'üìç END';
          el.appendChild(pin);
        }
        if(isInRange) el.classList.add('range');
        if(full.has(ds)) el.classList.add('dis');

        el.onclick = ()=>pickDate(date);
        cal.appendChild(el);
      }

      const hint = $("dateHint");
      if(!state.start && !state.end) {
        hint.innerHTML = '<div class="instruction-box"><span class="step">STEP 1:</span> Click a date to select your rental period. Click once for same-day rental, or click two different dates for multi-day rental.</div>';
      } else if(state.start && !state.end) {
        hint.innerHTML = `<div class="instruction-box"><span class="step">STEP 1:</span> Start date selected: ${fmtDate(state.start)} ‚Äî Click another date to extend your rental, or click times below to continue.</div>`;
      } else if(state.start && state.end) {
        if(sameDay(state.start, state.end)) {
          hint.innerHTML = `<div class="date-range-display">üìÖ Same-Day Rental: ${fmtDate(state.start)}<br><small style="opacity:0.7">Click a different date to extend your rental period</small></div>`;
        } else {
          const days = Math.ceil((state.end - state.start) / (1000*60*60*24)) + 1;
          hint.innerHTML = `<div class="date-range-display">üìÖ ${fmtDate(state.start)} ‚Üí ${fmtDate(state.end)} <span style="color:var(--green)">(${days} day${days>1?'s':''})</span><br><small style="opacity:0.7">Click a date to adjust your rental period</small></div>`;
        }
      }
    }

    function pickDate(date){
      if(!state.start || !state.end){
        // No selection yet: set same-day rental by default
        state.start = date; state.end = date; state.pickup=null; state.dropoff=null;
      } else if(sameDay(state.start, state.end)){
        // Currently same-day rental: extend range or keep same
        if(sameDay(date, state.start)){
          // Clicking same day: keep as same-day rental
          state.end = date;
        } else if(date < state.start){
          // Earlier date: move start backward
          state.start = date; state.pickup=null; state.dropoff=null;
        } else {
          // Later date: extend end forward
          state.end = date; state.pickup=null; state.dropoff=null;
        }
      } else {
        // Currently multi-day range: reset to new same-day rental
        state.start = date; state.end = date; state.pickup=null; state.dropoff=null;
      }
      draw();
    }

    function disabledHours(){
      if(!state.start || !state.end) return {pickup:[], dropoff:[]};
      const rFor = state.reservations.filter(r=>r.trailer===state.trailer);
      const dis = new Set();
      const range = { startDate: fmtDate(state.start), endDate: fmtDate(state.end), pickupHour:6, dropoffHour:18 };
      rFor.forEach(r=>{ if(overlaps(range,r)){ for(let h=r.pickupHour; h<=r.dropoffHour; h++) dis.add(h); } });
      const arr = [...dis].sort((a,b)=>a-b);
      return { pickup: arr, dropoff: arr };
    }

    function renderTimes(){
      const dis = disabledHours();
      const p = $("pickup"), d=$("dropoff"); p.innerHTML=""; d.innerHTML="";
      HOURS.forEach(h=>{
        const bp = document.createElement('button');
        bp.className='time'+(state.pickup===h?' sel':'')+(dis.pickup.includes(h)?' dis':'');
        bp.textContent=timeLabel(h); bp.disabled=dis.pickup.includes(h);
        bp.onclick=()=>{ state.pickup=h; draw(); };
        p.appendChild(bp);

        const bd = document.createElement('button');
        bd.className='time'+(state.dropoff===h?' sel':'')+(dis.dropoff.includes(h)?' dis':'');
        bd.textContent=timeLabel(h); bd.disabled=dis.dropoff.includes(h);
        bd.onclick=()=>{ state.dropoff=h; draw(); };
        d.appendChild(bd);
      });
    }

    function renderSummary(){
      // Check if all fields are selected
      const allSelected = state.trailer && state.start && state.end &&
                          state.pickup!==null && state.dropoff!==null && state.dropoff>=state.pickup;

      // Calculate total hours to check 2-hour minimum
      let totalHours = 0;
      let meets2HourMin = true;
      const warningDiv = $("timeWarning");

      if (allSelected) {
        const startDateTime = new Date(state.start);
        startDateTime.setHours(state.pickup, 0, 0, 0);
        const endDateTime = new Date(state.end);
        endDateTime.setHours(state.dropoff, 0, 0, 0);
        totalHours = (endDateTime - startDateTime) / (1000 * 60 * 60);

        if (totalHours < 2) {
          meets2HourMin = false;
          warningDiv.innerHTML = '<div class="instruction-box warning" style="margin-top:10px"><span class="step">‚ö†Ô∏è WARNING:</span> You have selected <strong>' + totalHours + ' hour' + (totalHours !== 1 ? 's' : '') + '</strong>. Minimum rental is <strong>2 hours</strong>. Please adjust your dropoff time.</div>';
        } else {
          warningDiv.innerHTML = '';
        }
      } else {
        warningDiv.innerHTML = '';
      }

      const ready = allSelected && meets2HourMin;
      $("bookBtn").disabled = !ready;

      const priceInfo = calculatePrice();
      $("summary").textContent = ready
        ? `${state.trailer} ‚Äî ${fmtDate(state.start)} ‚Üí ${fmtDate(state.end)}, ${timeLabel(state.pickup)} ‚Üí ${timeLabel(state.dropoff)}${priceInfo ? ` ‚Äî Estimated: $${priceInfo.price}` : ''}`
        : allSelected && !meets2HourMin
          ? '‚ö†Ô∏è Rental does not meet 2-hour minimum. Please adjust times.'
          : 'Pick trailer, dates & times to book.';
    }

    function draw(){ renderTrailers(); renderMonth(); renderTimes(); renderSummary(); }

    // Nav
    $("prev").onclick = ()=>{ state.visible = new Date(state.visible.getFullYear(), state.visible.getMonth()-1, 1); draw(); };
    $("next").onclick = ()=>{ state.visible = new Date(state.visible.getFullYear(), state.visible.getMonth()+1, 1); draw(); };

    // Modal controls
    $("bookBtn").onclick = ()=>{
      $("kv").innerHTML = '';
      const add=(t)=>{ const b=document.createElement('div'); b.className='kv'; b.textContent=t; $("kv").appendChild(b); };
      add(state.trailer);
      add(`${fmtDate(state.start)} ‚Üí ${fmtDate(state.end)}`);
      add(`${timeLabel(state.pickup)} ‚Üí ${timeLabel(state.dropoff)}`);

      // Add pricing info
      const priceInfo = calculatePrice();
      if (priceInfo) {
        const priceDiv = document.createElement('div');
        priceDiv.className = 'kv';
        priceDiv.style.cssText = 'background:#e8f5e9;color:#2e7d32;font-weight:600;padding:12px;border-radius:6px';
        priceDiv.innerHTML = `üí∞ Estimated Price: $${priceInfo.price}<br><small style="font-weight:400;opacity:0.8">${priceInfo.tier} ‚Ä¢ ${priceInfo.breakdown}</small>`;
        $("kv").appendChild(priceDiv);
      }

      $("modal").classList.add('open');
    };
    ["closeModal","cancel"].forEach(id=>$(id).onclick=()=>$("modal").classList.remove('open'));

    // Compress and resize image to reduce file size
    async function compressImage(file, maxWidth = 1200, quality = 0.8) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (e) => {
          const img = new Image();
          img.onload = () => {
            const canvas = document.createElement('canvas');
            let width = img.width;
            let height = img.height;

            // Resize if image is too large
            if (width > maxWidth) {
              height = (height * maxWidth) / width;
              width = maxWidth;
            }

            canvas.width = width;
            canvas.height = height;

            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, width, height);

            // Convert to base64 with compression
            const base64 = canvas.toDataURL('image/jpeg', quality).split(',')[1];
            resolve(base64);
          };
          img.onerror = reject;
          img.src = e.target.result;
        };
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    $("submit").onclick = async ()=>{
      console.log('=== SUBMIT BUTTON CLICKED ===');

      // Get license file and compress/convert to base64 if present
      const licenseFile = $("license").files[0];
      let licenseData = null;
      let licenseFilename = null;

      if (licenseFile) {
        try {
          console.log('Processing driver license image...');
          // Compress and resize image
          licenseData = await compressImage(licenseFile);
          licenseFilename = licenseFile.name.replace(/\.[^/.]+$/, '.jpg'); // Change extension to .jpg
          console.log('License processed:', licenseFilename);
        } catch (error) {
          console.error('License processing error:', error);
          alert('Failed to process driver\'s license image. Please try a different photo.');
          return;
        }
      }

      // Get insurance file and compress/convert to base64 if present
      const insuranceFile = $("insurance").files[0];
      let insuranceData = null;
      let insuranceFilename = null;

      if (insuranceFile) {
        try {
          console.log('Processing insurance image...');
          // Compress and resize image
          insuranceData = await compressImage(insuranceFile);
          insuranceFilename = insuranceFile.name.replace(/\.[^/.]+$/, '.jpg'); // Change extension to .jpg
          console.log('Insurance processed:', insuranceFilename);
        } catch (error) {
          console.error('Insurance processing error:', error);
          alert('Failed to process insurance image. Please try a different photo.');
          return;
        }
      }

      const record = {
        trailer: state.trailer,
        startDate: fmtDate(state.start),
        endDate: fmtDate(state.end),
        pickupHour: state.pickup,
        dropoffHour: state.dropoff,
        firstName: $("fn").value.trim(),
        lastName: $("ln").value.trim(),
        email: $("email").value.trim(),
        phone: $("phone").value.trim(),
        dob: $("dob").value,
        driversLicense: licenseData,
        driversLicenseFilename: licenseFilename,
        proofOfInsurance: insuranceData,
        proofOfInsuranceFilename: insuranceFilename,
        reason: $("reason").value.trim(),
        trailerExperience: $("trailerExperience").value,
        createdAt: new Date().toISOString(),
      };

      console.log('Booking record created:', {
        trailer: record.trailer,
        email: record.email,
        hasLicense: !!record.driversLicense,
        hasInsurance: !!record.proofOfInsurance
      });

      const missing = [];
      if(!record.firstName) missing.push('First name');
      if(!record.lastName) missing.push('Last name');
      if(!record.email) missing.push('Email');
      if(!record.phone) missing.push('Phone number');
      if(!record.dob) missing.push('Date of birth');
      if(!record.driversLicense) missing.push('Driver\'s license photo');
      if(!record.proofOfInsurance) missing.push('Proof of insurance photo');
      if(!record.reason) missing.push('What are you hauling');
      if(!record.trailerExperience) missing.push('Trailer experience');
      if(missing.length){
        console.error('Missing fields:', missing);
        alert('Please fill: '+missing.join(', '));
        return;
      }

      // Create Stripe checkout session and redirect to payment
      try {
        // Prevent modal from closing during process
        $("closeModal").disabled = true;
        $("cancel").disabled = true;
        $("submit").disabled = true;
        $("submit").textContent = "Creating payment session...";
        console.log('Calling API:', CHECKOUT_API_ENDPOINT);

        const resp = await fetch(CHECKOUT_API_ENDPOINT, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(record)
        }).catch(err => {
          console.error('FETCH ERROR (network/CORS):', err);
          throw new Error('Network error: ' + err.message);
        });

        console.log('Response received. Status:', resp.status);
        console.log('Response headers:', Array.from(resp.headers.entries()));

        if (!resp.ok) {
          let errorText = 'Unknown error';
          try {
            errorText = await resp.text();
            console.error('Error response body:', errorText);
          } catch (e) {
            console.error('Could not read error response:', e);
          }
          throw new Error(`Server error (${resp.status}): ${errorText}`);
        }

        let data;
        try {
          data = await resp.json();
          console.log('Response data:', data);
        } catch (e) {
          console.error('Failed to parse JSON response:', e);
          throw new Error('Invalid response from server');
        }

        if (!data || !data.url) {
          console.error('No URL in response! Response:', data);
          throw new Error("Server didn't return a payment URL");
        }

        console.log('SUCCESS! Got payment URL:', data.url);

        // Show loading overlay and close modal
        $("modal").classList.remove('open');
        $("loadingOverlay").classList.add('show');

        // Mobile browsers need immediate redirect (no setTimeout)
        console.log('Attempting redirect to Stripe...');

        // Store URL in case redirect fails
        window.stripeCheckoutUrl = data.url;

        // Try immediate redirect (best for mobile)
        try {
          window.location.href = data.url;
        } catch (e) {
          console.error('Redirect method 1 failed:', e);
          try {
            window.location.replace(data.url);
          } catch (e2) {
            console.error('Redirect method 2 failed:', e2);
            // Fallback: show manual button
            $("loadingOverlay").innerHTML = `
              <div style="text-align:center;max-width:90%;padding:20px">
                <div style="font-size:20px;margin-bottom:16px">‚ö†Ô∏è Redirect Blocked</div>
                <div style="font-size:16px;margin-bottom:20px">Your browser blocked the automatic redirect.</div>
                <button onclick="window.location.href='${data.url}'" style="background:var(--green);color:black;font-weight:700;font-size:18px;padding:16px 32px;border:none;border-radius:12px;cursor:pointer">
                  Continue to Payment
                </button>
              </div>
            `;
          }
        }

      } catch (e) {
        console.error('=== PAYMENT ERROR ===');
        console.error('Error type:', e.constructor.name);
        console.error('Error message:', e.message);
        console.error('Full error:', e);

        // Hide loading overlay and re-enable modal
        $("loadingOverlay").classList.remove('show');
        $("modal").classList.add('open');
        $("closeModal").disabled = false;
        $("cancel").disabled = false;
        $("submit").disabled = false;
        $("submit").textContent = "Pay & Book";

        alert("Payment setup failed:\n\n" + e.message + "\n\nCheck browser console (F12) for details.");
      }
    };

    // Init
    draw();

    // Handle return from Stripe checkout
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('success') === 'true') {
      const t = document.createElement("div");
      t.className = "toast";
      t.style.cssText = "position:fixed;right:14px;bottom:64px;background:#06F713;padding:16px 20px;border-radius:12px;box-shadow:0 10px 20px rgba(0,0,0,.1);font-size:15px;max-width:360px;line-height:1.5;font-weight:600";
      t.textContent = "üéâ Payment successful! Your trailer booking is confirmed. Check your email for details.";
      document.body.appendChild(t);
      setTimeout(() => {
        t.remove();
        // Clean URL
        window.history.replaceState({}, document.title, window.location.pathname);
      }, 8000);
    } else if (urlParams.get('canceled') === 'true') {
      const t = document.createElement("div");
      t.className = "toast";
      t.style.cssText = "position:fixed;right:14px;bottom:64px;background:#ff6b6b;color:white;padding:16px 20px;border-radius:12px;box-shadow:0 10px 20px rgba(0,0,0,.1);font-size:15px;max-width:360px;line-height:1.5";
      t.textContent = "Payment was canceled. You can try booking again when you're ready.";
      document.body.appendChild(t);
      setTimeout(() => {
        t.remove();
        // Clean URL
        window.history.replaceState({}, document.title, window.location.pathname);
      }, 6000);
    }
  </script>
</body>
</html>

